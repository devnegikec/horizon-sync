# Mock Service Worker (MSW) Setup

Mock Service Worker is configured to intercept API calls in development mode and return mock data.

## Features

âœ… **Automatic in Development**: MSW automatically starts in development mode
âœ… **No Code Changes**: Your services work with both real and mock APIs without changes
âœ… **Console Logging**: All intercepted requests are logged with ðŸ”µ prefix
âœ… **Easy Toggle**: Simply comment out the MSW initialization to use real API

## Configuration Files

### 1. Mock Data
`apps/platform/src/app/mocks/data/users.ts`
- Contains 10 mock users with various statuses (active, pending, inactive)
- Realistic data with emails, names, login times, etc.

### 2. API Handlers
`apps/platform/src/app/mocks/handlers.ts`
- **GET /api/v1/users** - Returns paginated users with mock data
- **POST /api/v1/users/invite** - Simulates user invitation
- **POST /api/v1/auth/login** - Mock login endpoint
- **POST /api/v1/auth/register** - Mock registration endpoint

### 3. MSW Worker
`apps/platform/src/app/mocks/browser.ts`
- Configures the Service Worker with handlers

### 4. Service Worker File
`apps/platform/src/mockServiceWorker.js`
- Generated by MSW - interceptsnetwork requests in the browser

## How It Works

1. When the app starts in development, `main.ts` initializes MSW
2. MSW installs a Service Worker in the browser
3. All network requests matching the handlers are intercepted
4. Mock responses are returned instead of hitting the real API
5. Console shows which requests were mocked with ðŸ”µ prefix

## Endpoints Mocked

### Users API

#### GET /api/v1/users
**Query Parameters:**
- `page` - Page number (default: 1)
- `page_size` - Items per page (default: 20)

**Response:**
```json
{
  "items": [...],
  "total": 10,
  "page": 1,
  "page_size": 20,
  "pages": 1,
  "has_next": false,
  "has_prev": false
}
```

#### POST /api/v1/users/invite
**Body:**
```json
{
  "email": "user@example.com",
  "first_name": "John",
  "last_name": "Doe",
  "role_id": "optional-role-id",
  "message": "Welcome!"
}
```

**Response:**
```json
{
  "invitation_id": "uuid",
  "email": "user@example.com",
  "expires_at": "2026-01-28T...",
  "invitation_url": "https://app.horizonsync.com/accept-invitation?token=..."
}
```

### Auth API

#### POST /api/v1/auth/login
**Body:**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**Response:**
```json
{
  "access_token": "mock_access_token_...",
  "token_type": "Bearer",
  "user_id": "uuid",
  "email": "user@example.com",
  "organization_id": "uuid",
  "message": "Login successful"
}
```

#### POST /api/v1/auth/register
**Body:**
```json
{
  "email": "user@example.com",
  "password": "password123",
  "first_name": "John",
  "last_name": "Doe",
  "organization_name": "Acme Corp"
}
```

## Switching to Real API

### Option 1: Temporary (Current Session)
Comment out MSW initialization in `apps/platform/src/main.ts`:

```typescript
async function prepare() {
  // Disable MSW temporarily
  // if (process.env.NODE_ENV === 'development') {
  //   const { worker } = await import('./app/mocks');
  //   await worker.start({ onUnhandledRequest: 'bypass' });
  //   console.log('ðŸ”µ MSW: Mock Service Worker is running');
  // }
  return import('./bootstrap');
}
```

### Option 2: Environment Variable (Recommended)
Add to `.env`:
```bash
NX_USE_MOCK_API=false
```

Then update `main.ts`:
```typescript
async function prepare() {
  const useMockAPI = process.env['NX_USE_MOCK_API'] !== 'false';
  
  if (process.env.NODE_ENV === 'development' && useMockAPI) {
    const { worker } = await import('./app/mocks');
    await worker.start({ onUnhandledRequest: 'bypass' });
    console.log('ðŸ”µ MSW: Mock Service Worker is running');
  }
  return import('./bootstrap');
}
```

## Adding New Mock Endpoints

1. **Add mock data** in `mocks/data/` directory
2. **Add handler** in `mocks/handlers.ts`:

```typescript
http.get(`${API_BASE_URL}/your-endpoint`, ({ request }) => {
  console.log('ðŸ”µ MSW: GET /your-endpoint');
  return HttpResponse.json(yourMockData, { status: 200 });
}),
```

3. **No changes needed** in your services or components!

## Debugging

- Check browser console for ðŸ”µ MSW logs
- Open DevTools â†’ Network tab to see intercepted requests
- Requests show "from ServiceWorker" in the Network tab
- Add `console.log` in handlers to debug request/response data

## Production

MSW is automatically disabled in production builds. The condition `process.env.NODE_ENV === 'development'` ensures it only runs locally.

## Troubleshooting

### Service Worker not registering
1. Clear browser cache
2. Unregister existing service workers (DevTools â†’ Application â†’ Service Workers)
3. Restart dev server

### Requests not being intercepted
1. Check that the URL matches exactly in handlers
2. Verify MSW started (look for console message)
3. Check Network tab shows "from ServiceWorker"

### Want to see real API calls
1. Open DevTools â†’ Network tab
2. Check "Bypass for network" in Service Workers section
3. Or temporarily disable MSW as described above
